<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Certificate List</title>
    <link rel="icon" href="/static/favicon.ico" type="image/x-icon">
    <!-- Materialize CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@materializecss/materialize@2.1.1/dist/css/materialize.min.css">
    <!-- Material Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="/static/styles.css">
    <style>
        .collapsible-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .collapsible-header .left-content {
            display: flex;
            align-items: center;
            flex-grow: 1;
        }
        .collapsible-header .spacer {
            display: flex;
            width: 100%;
            flex-grow: 1;
        }
        .collapsible-header .right-content {
            display: flex;
            gap: 10px;
            flex-grow: 1
        }
    </style>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            M.AutoInit();

            // Initialize all collapsibles
            var collapsibles = document.querySelectorAll('.collapsible');
            collapsibles.forEach(function(collapsible) {
                var toggleBtn = collapsible.querySelector('.toggle-view-btn');
                if (toggleBtn) {  // Only for collapsibles with view buttons
                    var btnText = toggleBtn.querySelector('.btn-text');
                    var btnIcon = toggleBtn.querySelector('.material-icons');

                    collapsible.addEventListener('click', function(e) {
                        setTimeout(function() {
                            var isOpen = collapsible.querySelector('li').classList.contains('active');
                            btnText.textContent = isOpen ? 'Hide Certificate' : 'View Certificate';
                            btnIcon.textContent = isOpen ? 'visibility_off' : 'visibility';
                        }, 100);
                    });
                }
            });

            // Auto-open root certificate collapsible if it has the create button
            var rootCollapsible = document.querySelector('.collapsible:not(.root-cert):not(.homelab-cert)');
            if (rootCollapsible && rootCollapsible.querySelector('a[href="/"]')) {
                var instance = M.Collapsible.getInstance(rootCollapsible);
                instance.open(0);
            }

            // Auto-open self-signed certificate warning if it exists
            var selfSignedCollapsible = document.querySelector('.collapsible:has(button[onclick="recreateHomelabCert()"])');
            if (selfSignedCollapsible) {
                var instance = M.Collapsible.getInstance(selfSignedCollapsible);
                instance.open(0);
            }
        });

        function viewCertificate(certName) {
            fetch(`/certificates/view/${certName}.pem`)
                .then(response => response.json())
                .then(data => {
                    document.getElementById(`certDecodedContent-${certName}`).innerText = data.decoded;
                    document.getElementById(`certRow-${certName}`).style.display = 'table-row';
                    document.getElementById(`viewButton-${certName}`).style.display = 'none';
                    document.getElementById(`hideButton-${certName}`).style.display = 'inline';
                })
                .catch(error => {
                    M.toast({html: 'Error fetching certificate: ' + error, classes: 'red darken-1'});
                });
        }

        function hideCertificate(certName) {
            document.getElementById(`certRow-${certName}`).style.display = 'none';
            document.getElementById(`viewButton-${certName}`).style.display = 'inline';
            document.getElementById(`hideButton-${certName}`).style.display = 'none';
        }
        // Initialize theme before page load
        const theme = localStorage.getItem('theme') || 'light';
        document.documentElement.setAttribute('data-theme', theme);
        document.body.setAttribute('data-theme', theme);
    </script>
</head>
<body class="{{.theme}}" data-theme="{{.theme}}">
    <div class="certificate-page">
        {{ template "header.html" . }}
        <div class="container">
            <h1 class="center-align">Certificates</h1>

            <!-- Root Certificate Section -->
            <div class="row">
                <div class="col s12">
                    {{if .rootCertificate}}
                    <ul class="collapsible root-cert">
                        <li>
                            <div class="collapsible-header">
                                    <div class="left-content">
                                        <i class="material-icons">security</i>
                                        <span style="margin-left: 8px; white-space: nowrap;">HomeLAB Root CA Certificate</span>
                                    </div>
                                    <div class="spacer"></div>
                                    <div class="right-content">
                                        <button class="waves-effect waves-light btn toggle-view-btn">
                                            <i class="material-icons left">visibility</i>
                                            <span class="btn-text">View Certificate</span>
                                        </button>
                                        <div class="spacer"></div>
                                        <form action="/certificates/download/root-cert/HomeLab_Root_CA.pem" method="GET" style="margin-right: 10px;">
                                                <button type="submit" class="btn blue">
                                                    <i class="material-icons left">download</i>
                                                    <span class="btn-text">Download</span>
                                                </button>
                                        </form>
                                    </div>
                            </div>
                            <div class="collapsible-body">
                                <p><strong>Issuer:</strong> {{.rootCertificate.Issuer}}</p>
                                <p><strong>Subject:</strong> {{.rootCertificate.Subject}}</p>
                                <p><strong>Validity:</strong> Not Before: {{.rootCertificate.NotBefore}}, Not After: {{.rootCertificate.NotAfter}}</p>
                            </div>
                        </li>
                    </ul>
                    {{else}}
                    <ul class="collapsible">
                        <li>
                            <div class="collapsible-header" style="display: flex; justify-content: space-between; align-items: center;">
                                <div style="display: flex; align-items: center;">
                                    <i class="material-icons orange-text">warning</i>
                                    <span style="margin-left: 8px;">Root Certificate</span>
                                </div>
                                <div>
                                    <a href="/" class="waves-effect waves-light btn orange">
                                        <i class="material-icons left">add</i>
                                        Create Root Certificate
                                    </a>
                                </div>
                            </div>
                            <div class="collapsible-body">
                                <div class="card-panel yellow lighten-4">
                                    <i class="material-icons left">info</i>
                                    <span>No root certificate found. Please create one to start issuing certificates.</span>
                                </div>
                            </div>
                        </li>
                    </ul>
                    {{end}}

                <!-- HomeLAB Certificate Section -->
                {{if .homelabCertificate}}
                    <div class="row">
                        <div class="col s12">
                            <ul class="collapsible homelab-cert">
                                <li>
                                    <div class="collapsible-header">
                                        <div class="left-content">
                                            <i class="material-icons">verified_user</i>
                                            <span style="margin-left: 8px; white-space: nowrap;">HomeLab Certificate Manager Certificate</span>
                                        </div>
                                        <div class="spacer"></div>
                                        <div>
                                            <button class="waves-effect waves-light btn toggle-view-btn">
                                                <i class="material-icons left">visibility</i>
                                                <span class="btn-text">View Certificate</span>
                                            </button>
                                        </div>
                                        <div class="spacer"></div>
                                        <div>
                                            <button onclick="recreateHomelabCert()" class="waves-effect waves-light btn orange">
                                                <i class="material-icons left">autorenew</i>
                                                Recreate with Homelab-RootCA
                                            </button>
                                        </div>
                                    </div>
                                    <div class="collapsible-body">
                                        <p><strong>Issuer:</strong> {{.homelabCertificate.Issuer}}</p>
                                        <p><strong>Subject:</strong> {{.homelabCertificate.Subject}}</p>
                                        <p><strong>Validity:</strong> Not Before: {{.homelabCertificate.NotBefore}}, Not After: {{.homelabCertificate.NotAfter}}</p>
                                    </div>
                                </li>
                            </ul>
                        </div>
                    </div>
                    {{else if .selfSignedExists}}
                    <ul class="collapsible">
                        <li>
                            <div class="collapsible-header" style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                                <div style="display: flex; align-items: center; white-space: nowrap;">
                                    <i class="material-icons orange-text">warning</i>
                                    <span style="margin-left: 8px;">Self-Signed Certificate</span>
                                </div>
                                <div class="right">
                                    <button onclick="recreateHomelabCert()" class="waves-effect waves-light btn orange">
                                        <i class="material-icons left">autorenew</i>
                                        Recreate with Homelab-RootCA
                                    </button>
                                </div>
                            </div>
                            <div class="collapsible-body">
                                <div class="card-panel yellow lighten-4" style="color: black;">
                                    <i class="material-icons left">info</i>
                                    <span>This is a self-signed certificate. For better security, recreate it using your Homelab Root CA.</span>
                                </div>
                                <p><strong>Subject:</strong> HomeLab Certificate Manager</p>
                                <p><strong>Type:</strong> Self-Signed Certificate</p>
                            </div>
                        </li>
                    </ul>
                    {{else}}
                    <div class="card-panel yellow lighten-4" style="color: black;">
                        <i class="material-icons left">warning</i>
                        <span>No certificate found. A self-signed certificate will be generated automatically when needed.</span>
                    </div>
                    {{end}}
                </div>
            </div>

            
            <!-- Certificates Section -->
            <div class="row">
                <a href="/create-certificate-form" class="btn waves-effect green white-text">Create New Certificate</a>
            </div>

            <table class="highlight centered">
                <thead>
                    <tr>
                        <th>Certificate</th>
                        <th>Created</th>
                        <th>Valid Until</th>
                        <th>Subject Alternative Names</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {{range .certificates}}
                    <tr>
                        <td><b>{{.Name}}</b></td>
                        <td>{{.CreatedAt.Format "2006-01-02 15:04:05"}}</td>
                        <td>{{.ValidUntil.Format "2006-01-02 15:04:05"}}</td>
                        <td>{{range .SANs}}{{.}}<br>{{end}}</td>
                        <td>
                            <button class="btn-small waves-effect waves-light dropdown-trigger blue" data-target="dropdown-{{.Name}}">
                                <i class="material-icons">download</i>
                            </button>
                            <ul id="dropdown-{{.Name}}" class="dropdown-content">
                                <li><a href="#" onclick="downloadCertificate('{{.Name}}', 'pem')">Download PEM</a></li>
                                <li><a href="#" onclick="downloadCertificate('{{.Name}}', 'key')">Download KEY</a></li>
                                <li><a href="#" onclick="downloadCertificate('{{.Name}}', 'pfx')">Download PFX</a></li>
                            </ul>
                            <form id="delete-cert-form-{{.Name}}" action="/certificates/delete/{{.Name}}.pem" method="POST" style="display:inline;">
                                <button type="button" class="btn-small red waves-effect waves-light" onclick="confirmDelete('{{.Name}}')">
                                    <i class="material-icons">delete</i>
                                </button>
                            </form>
                        </td>
                    </tr>
                    <tr id="certRow-{{.Name}}" style="display:none;">
                        <td colspan="5">
                            <pre id="certContent-{{.Name}}" class="materialize-textarea left-align"></pre>
                            <pre id="certDecodedContent-{{.Name}}" class="materialize-textarea left-align"></pre>
                        </td>
                    </tr>
                    {{end}}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Materialize JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/@materializecss/materialize@2.1.1/dist/js/materialize.min.js"></script>
    <!-- Custom JavaScript -->
    <script src="/static/script.js"></script>
    <script>
        M.AutoInit();

        document.addEventListener('DOMContentLoaded', function() {
            // Initialize Materialize components
            M.updateTextFields();
            
            // Initialize theme
            const currentTheme = localStorage.getItem('theme') || 'light';
            applyTheme(currentTheme);

            // Initialize dropdowns
            var dropdowns = document.querySelectorAll('.dropdown-trigger');
            M.Dropdown.init(dropdowns, {
                constrainWidth: false,
                coverTrigger: false
            });
        });

        function downloadCertificate(certName, type) {
            window.location.href = `/certificates/download/${certName}.${type}`;
        }

        function confirmDelete(certName) {
            if (confirm('Are you sure you want to delete this certificate? This action cannot be undone.')) {
                document.getElementById('delete-cert-form-' + certName).submit();
            }
        }

    </script>
</body>
</html>